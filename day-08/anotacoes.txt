SECRETS
#######

Os Secrets fornecem uma maneira segura e flexivel de gerenciar informaçoes sensiveis, como senhas, tokens OAuth, chaves SSH e outros
dados que voce nao quer expor nas configuraçoes de suas aplicaçoes.

Um Secret contem um pequeno volume de informaçoes sensiveis, como senha, token ou uma chave. Essas informaçoes podem ser consumidas 
por PODs ou usadas pelo sistema para realizar açoes em nome de um POD.

Os Secrets sao armazenados no Etcd, o armazenamento de dados distribuido do Kubernetes. Por padrao, eles sao armazenados sem criptografia, 
embora o Etcd suporte criptografia para proteger os dados armazenados nele. 
Alem disso, o acesso aos Secrets e restrito por meio de Role-Based Access Control (RBAC), o que permite controlar quais usuarios e PODs 
podem acessar quais Secrets.

Os Secrets podem ser montados em PODs como arquivos em volumes ou podem ser usados para preencher variaveis de ambiente para um container 
dentro de um POD. Quando um Secret e atualizado, o Kubernetes nao atualiza automaticamente os volumes montados ou as variaveis de ambiente 
que se referem a ele.

Alguns tipos de Secrets mais utilizados:


    Opaque Secrets
    ++++++++++++++

    Sao os Secrets mais simples e mais comuns. Eles armazenam dados arbitrarios, como chaves de API, senhas e tokens. Os Opaque Secrets 
    sao codificados em base64 quando sao armazenados no Kubernetes, mas nao sao criptografados. Eles podem ser usados para armazenar dados 
    confidenciais, mas nao sao seguros o suficiente para armazenar informaçoes altamente sensiveis, como senhas de banco de dados.

    kubernetes.io/service-account-token
    +++++++++++++++++++++++++++++++++++

    Sao usados para armazenar tokens de acesso de conta de serviço. Esses tokens sao usados para autenticar PODs com o Kubernetes API. Eles 
    sao montados automaticamente em PODs que usam contas de serviço.

    kubernetes.io/dockercfg e kubernetes.io/dockerconfigjson
    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    Armazenam credenciais que sao usadas para autenticar PODs no Registry do Docker. Eles sao montados em PODs que usam imagens de container 
    privadas.

    kubernetes.io/tls, kubernetes.io/ssh-auth e kubernetes.io/basic-auth
    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    
    Sao usados para armazenar certificados TLS, chaves SSH e credenciais de autenticação basica, respectivamente. Eles sao usados para 
    autenticar PODs com outros serviços.

    bootstrap.kubernetes.io/token
    +++++++++++++++++++++++++++++
    
    Sao usados para armazenar tokens de inicializaçao de cluster kubernetes. Eles sao usados para autenticar nos no Control-Plane do Kubernetes.


Cada tipo de Secret tem formatos diferentes. Por exemplo, os Secrets Opaque sao armazenados como um mapa de strings, enquanto os Secrets TLS sao 
armazenados como um mapa de strings com chaves adicionais para armazenar certificados e chaves, por isso e importante saber qual tipo de Secret 
voce esta usando para armazenar os dados corretamente.

IMPORTANTE
##########

Base64 nao deve ser considerado como criptografia. Seu proposito nao e este. E apenas um esquema de codificaçao binaria para texto que visa garantir 
que os dados binarios possam ser enviados por canais que sao projetados para lidar apenas com texto. Esta codificaçao ajuda a garantir que os dados 
permaneçam intactos sem modificaçao durante o transporte.

E muito utilizado em varias aplicaçoes, incluindo e-mail via MIME, armazenamento de senhas complexas, e muito mais.

A codificaçao Base64 converte os dados binarios em uma string de texto ASCII. Essa string contem apenas caracteres que sao considerados seguros 
para uso em URLs, o que torna a codificaçao Base64 util para codificar dados que estao sendo enviados pela Internet.

Base64 não fornece confidencialidade. Qualquer um que tenha acesso a string codificada pode facilmente decodifica-la e recuperar os dados originais.


Comandos Uteis
##############

Mascarando uma String via Base64

#> echo "Mascarando isso via Base64" | base64
Resultado => TWFzY2FyYW5kbyBpc3NvIHZpYSBCYXNlNjQK

Desmascarando uma String via Base64

#> echo -n "TWFzY2FyYW5kbyBpc3NvIHZpYSBCYXNlNjQK" | base64 -d
Resultado => Mascarando isso via Base64

Criando um Secret Opaque por linha de comando

#> kubectl create secret generic xpto-secret --from-literal=user=eHB0b3VzZXIK --from-literal=pwd=YW55IHZhbHVlCg==

Criacao de um certificado TLS auto-assinado via openssl (Apenas para teste)

#> openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout xpto.key -out xpto.crt

Criando o manifesto do Secret TLS

#> kubectl create secret tls xpto-tls-secret --cert=certificates/xpto.crt --key=certificates/xpto.key --dry-run=client -o yaml > xpto-tls-secret.yml

Criando o manifesto do ConfigMap

#> kubectl create configmap nginx-config --from-file=configs/nginx.conf --dry-run=client -o yaml > nginx-config.yml

Manifesto Exemplo Secret Opaque
+++++++++++++++++++++++++++++++

apiVersion: v1
kind: Secret
metadata:
  name: xpto-secret
type: Opaque
data:
  key0: dmFsdWUwCg==
  key1: dmFsdWUxCg==
  keyn: YW55IHZhbHVlCg==

#> echo "value0" | base64
Resultado => dmFsdWUwCg==

#> echo "value1" | base64
Resultado => dmFsdWUxCg==

#> echo "any value" | base64
Resultado => YW55IHZhbHVlCg==


Para usar o Secret em um POD, e necessario definir o campo spec.containers[].env[].valueFrom.secretKeyRef no arquivo YAML do POD.

Manifesto Exemplo POD usando Secret Opaque
++++++++++++++++++++++++++++++++++++++++++

apiVersion: v1
kind: Pod
metadata:
  name: pod-with-secret
spec:
  containers:
  - name: xpto-container
    image: nginx
    env: # Inicio da definiçao de variaveis de ambiente
    - name: USERNAME # Nome da variavel de ambiente que sera criada no POD
      valueFrom: # Inicio da definiçao de onde o valor da variavel de ambiente será buscado
        secretKeyRef: # Inicio da definiçao de que o valor da variavel de ambiente sera buscado de um Secret, atraves de uma chave
          name: xpto-secret # Nome do Secret que contem o valor da variavel de ambiente que sera usado no POD
          key: user # Nome da chave do campo do Secret que contem o valor da variavel de ambiente que sera usado no POD
    - name: PASSWORD # Nome da variavel de ambiente que sera criada no POD
      valueFrom: # Inicio da definiçao de onde o valor da variavel de ambiente sera buscado
        secretKeyRef: # Inicio da definiçao de que o valor da variavel de ambiente sera buscado de um Secret, atraves de uma chave
          name: xpto-secret # Nome do Secret que contem o valor da variavel de ambiente que sera usado no POD
          key: pwd # Nome da chave do campo do Secret que contem o valor da variavel de ambiente que sera usado no POD


Manifesto Exemplo Secret kubernetes.io/dockerconfigjson
+++++++++++++++++++++++++++++++++++++++++++++++++++++++

apiVersion: v1
kind: Secret
metadata:
  name: docker-hub-secret # nome do Secret
type: kubernetes.io/dockerconfigjson # tipo do Secret, neste caso e um Secret que armazena credenciais Docker
data:
  .dockerconfigjson: |  # Valor do conteudo do arquivo config.json codificado em Base64
    ewoJImF1dGhzIjogewoJCSJodHRwczovL2luZGV4LmRvY2tlci5pby92MS8iOiB7CgkJCSJhdXRoIjogImFHVm9aV2hsSUM0dUxpQk9ZVzhnWm05cElHUmxjM05oSUhabGVpQXVMaTRnVkdWdWRHVWdibUVnY0hKdmVHbHRZUT09IgoJCX0KCX0KfQo=


Manifesto Exemplo POD usando Secret kubernetes.io/dockerconfigjson
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

apiVersion: v1
kind: Pod
metadata:
  name: pod-with-secret-dockerconfigjson
spec:
  containers:
  - name: xpto-container
    image: imagemprivada:1.0  # Nome da imagem privada no DockerHub
  imagePullSecrets: # Inicio da definiçao de qual Secret sera utilizado para coletar as credenciais
  - name: docker-hub-secret # Nome da Secret onde esta configurada as credenciais ao Docker Hub que sera usado pelo POD
      

Manifesto Exemplo Secret TLS
++++++++++++++++++++++++++++

apiVersion: v1
kind: Secret
metadata:
  name: xpto-tls-secret
type: kubernetes.io/tls
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURwVENDQW8yZ0F3SUJBZ0lVTlhmeDBDNnR6YlNVdlhPbDR4b0NFdy9HQnJrd0RRWUpLb1pJaHZjTkFRRUwKQlFBd1lqRUxNQWtHQTFVRUJoTUNRbEl4Q3pBSkJnTlZCQWdNQWxOUU1SQXdEZ1lEVlFRSERBZENhWEpwWjNWcApNUkl3RUFZRFZRUUtEQWxZVUZSUElFbHVZeTR4Q3pBSkJnTlZCQXNNQWtsVU1STXdFUVlEVlFRRERBcDRjSFJ2CkxteHZZMkZzTUI0WERUSTJNREV3T1RJeE1EZ3lObG9YRFRJM01ERXdPVEl4TURneU5sb3dZakVMTUFrR0ExVUUKQmhNQ1FsSXhDekFKQmdOVkJBZ01BbE5RTVJBd0RnWURWUVFIREFkQ2FYSnBaM1ZwTVJJd0VBWURWUVFLREFsWQpVRlJQSUVsdVl5NHhDekFKQmdOVkJBc01Ba2xVTVJNd0VRWURWUVFEREFwNGNIUnZMbXh2WTJGc01JSUJJakFOCkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQXFMMEZpYTVBUy9YQWRHNERtcERmUlFYM2p0WkoKaXRHanVpTG5MNlhZSmYzU3ZRM2tPTXlscW9jYWxZUStTTWNpZ0xiWDRHVVZwYUpZSnZRYklDR01mNXRIV0lvTAo1MUw3SlR3L2dMT3pWQ0hKZytSQUtiT2I0Q0x5VktDUW5kbGVJYlI3UGh3dSszRWh3c09MVTcvNHpMalhzaTdiCnlRTmJPYkUyL1VvdHVXY2poY0VEdWtzaXpKcC82WTMxQzhLbVhYZzMvR2U3RmJGcVIxWWlhdHRGNDhiak11VHQKbk51ZW13Nkx0VkM0ZllRZ1JMR1hFbEdtY0FMQXA0ZTU0Yy9USHR1anZGUDkzdVB3ME9QZEp0K1gwYlhxZUpZLwpSdCtndTJwUWZ4WFFxcE9mRkowckZyMXo5YWhXSWJON1lnMFhKcVhtLzd0ekwxaTNkbmh4ZE5SSlNRSURBUUFCCm8xTXdVVEFkQmdOVkhRNEVGZ1FVbnV2TTJyYUoyazU2STJwUFkxNnhUa0NyTkdBd0h3WURWUjBqQkJnd0ZvQVUKbnV2TTJyYUoyazU2STJwUFkxNnhUa0NyTkdBd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBTkJna3Foa2lHOXcwQgpBUXNGQUFPQ0FRRUFlRU1DTHY4c3ZYcFl3SitNQUQ5QnNsME9Zb01WaVhPS3Q4T0NWcE1IOFRzNUJ5YVdjR045CkY5dlJsczNkM0YvWUtRaFVibUlVQ00rbXBSMUwyOGFWQlNCNjIyNGl2d1IxWkJiYzNDY2RsU1BJYlZWcjJzY3UKR1NFZFdoS2JHUURXMVY0eVZsWitrMmxaSnphUktqbC9UdElEUUt6WU5qdHk1UkxVY1FoeldqMDlVQjVrY1ZUUApzb09WaFQwYlZHczcvVGsvUmNEUldySmJocmsvaUdmaHdkWDhKV2VLVjBsbzIxTHo2MkoraFpWMWs0cjFXNGI1Ck9QYmY5VFcxNE9WTGREZTVreHE0bGFYdnJGZVhQQkJaYnMwSXAvNXUxUk5yMGpIY2V2eWNSTG1ObFQ5ZGR5dk4Kd21wWCswUnp5THlobnA1YXd0NndMM1JHZXV0ZktBSVJNUT09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
  tls.key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2QUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktZd2dnU2lBZ0VBQW9JQkFRQ292UVdKcmtCTDljQjAKYmdPYWtOOUZCZmVPMWttSzBhTzZJdWN2cGRnbC9kSzlEZVE0ektXcWh4cVZoRDVJeHlLQXR0ZmdaUldsb2xnbQo5QnNnSVl4L20wZFlpZ3ZuVXZzbFBEK0FzN05VSWNtRDVFQXBzNXZnSXZKVW9KQ2QyVjRodEhzK0hDNzdjU0hDCnc0dFR2L2pNdU5leUx0dkpBMXM1c1RiOVNpMjVaeU9Gd1FPNlN5TE1tbi9wamZVTHdxWmRlRGY4WjdzVnNXcEgKVmlKcTIwWGp4dU15NU8yYzI1NmJEb3UxVUxoOWhDQkVzWmNTVWFad0FzQ25oN25oejlNZTI2TzhVLzNlNC9EUQo0OTBtMzVmUnRlcDRsajlHMzZDN2FsQi9GZENxazU4VW5Tc1d2WFAxcUZZaHMzdGlEUmNtcGViL3UzTXZXTGQyCmVIRjAxRWxKQWdNQkFBRUNnZ0VBRnZZUnlOaHpXMkxIbTVCVTRUV1JqRHp4b1BnNzdhMzFUNkRzUUttYXJpREsKQ252WGNIczRsK25tamkzK283eWxUMHFTT2JESHIxQldHb2JoSWhBdXBEYW5FTDlJTzJRcFZMbk1FbUZocDdNcApUczlDZytveTdkOFRocnlLc1ZBZzVRbEFOQVYxeHpWdjJLYnZVS2d3M1ByU0x5YjlOVzlGZktaR3kxVEt3QTIyCk45eW1FM1Q5cHZ2MkRMSVY5cTZvSkJ4YlVZMDZPUE9tdnhneWFkS2I0QUp2cG1KQ1YrWnM0d2dZcUtNcTJOckEKUUlOL0R6OEQvb09xQkFXdU4ySVNSWDhlWTlhejlEU3FvNEVBZGJseXZnOEZCUmRxRkpCNzFTYVU1b3dhelAvQgpEQlRVTkQ5dllZWFI0TTV0bEk4Znk2Sm5YQnNRRVV3T0JrOExrY3NYdVFLQmdRRGNnaEZLdmhUdHhadE1ucXBTClhNekNha0prTHRuVUtCcHl4TG5jK0hCSGlMQjNVTnZPUXBzZWRNUHY1c01RTlZIbjFVRFNtYkhCeWJUYzJMTDkKTForSGRkZHNFcnRxRVI0RlBrb25pdjRLNTdkd3JDa3g5NkZRczcyd2o1amd3MHU0azg1SzVVWldORUlzVEwxbwpWbUx5a1dtY3F4cy9LVlZQRjJrVjhjUlROd0tCZ1FERDVjNnJZQ0tudkxlRlFnczdGeGFJd2Y1dzhURUVGcFhpCmVkdFM0WHNUM2hmQWJXQ0tQOE5SNUIvbkt1OG9YaFRvbUt0bHVGbUhJNVpGYXRQNzRrZy9Dci9KSGZCUERqcWQKVUxPcElURzkxOXZUVFBWOGt4YVNkMVFtdzRuOUJPTzNGZWthMWx6anZldDl3QTN5V1kxdFBxY01UNTVySU8rZQp1dU53MkZ1SGZ3S0JnRzBZVE1YVjFUVHVGeStKTUdzZlRvN0JVNmVOSm1nNGp4MUpCMHV6L3BqbG42am9jRmRUCnpMcjh1aFB1NzRNTlhrQjgyVjFZZlFHTGNkZnh2bHhVUGlFZXhEM0w1cjFMU3JiOVltSzkrWUlic2o0a2J4MHgKanJZR3QwcXJRTSt5ejd1NkpNNFpNUHRsVDNmclg2cEhVeHovcEdqR251eFkzc1FLcVFzYVdpOXhBb0dBTUNDMApmcXdXdDRrSXVXZDVaT0lPT2prVzd0NkN3Vk5mTFkzc2tWY3VLcnBrc1hUdHcrbFlialVTbFhPWjRCd0ZIUVB0CkVBZVRqenp4L1VuNm5LYUNRMks3clloNmNxRzNTdEQ1NHJKeUN3Y09UY0paaVdxRm9DUksrMThNOXFtTjNIdzQKa2N4YWMrVkVCdGY1VlRJbEtkSzdyYTJkNlFubGRPVExYZno1dDdjQ2dZQUlUK2wwSmhZZ1BnUDV1NGhJU2Z6YgppYWF0OVRFMFVLeFlQNGdncWhObmxtTGsyRmlXOGN1VVpERFphSVU1OEVlQUU2M2dtWUdwbkprY3ZhWWRzSENJCm1VR21rdmpqWW5kRTZVeS82RmduU0tNVEs2QUczOUJteEFMQ2RlQ0M1b1h3MkE5UlpwWkpOS0prNzhqYVpZTUIKVDJWL1ZkNi84S25yUWhFUWtsZlBKZz09Ci0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0K

DICA: Mais facil criar este manifesto via linha de comando.


CONFIG MAPS
###########

ConfigMaps sao usados para armazenar dados de configuraçao, como variaveis de ambiente, arquivos de configuraçao, etc. Eles 
sao muito uteis para armazenar dados de configuraçao que podem ser usados por varios PODs.

Os ConfigMaps sao uma maneira eficiente de desacoplar os parametros de configuraçao das imagens dos containers. Isso permite 
que voce tenha a mesma imagem de container em diferentes ambientes, como desenvolvimento, teste e produçao, com diferentes 
configuraçoes.

IMPORTANTE
##########

    Atualizaçoes => Nao sao atualizados automaticamente nos PODs que os utilizam. Se você atualizar um ConfigMap, somente 
    apos um restart do Deployment ou a recriacao dos PODs e que a nova configuracao sera utilizada.

    Multiplos ConfigMaps => E possível usar multiplos ConfigMaps para um unico POD. Isso e util quando voce tem diferentes 
    aspectos da configuraçao que quer mante-las separadas.

    Variaveis de ambiente => Alem de montar o ConfigMap em um volume, tambem e possivel usar o ConfigMap para definir variaveis 
    de ambiente para os containers nos PODs.

    Imutabilidade => A partir da versao 1.19 do Kubernetes, e possivel tornar ConfigMaps (e Secrets) imutaveis, o que pode melhorar 
    o desempenho do cluster se houver muitos ConfigMaps ou Secrets.

Praticamente os manifestos do ConfigMap sao iguais aos dos manifestos de Secrets, diferenciado pelos conteudos do campo kind e 
principalmente do campo data onde nao ha necessidade de adicionar seu conteudo como chave/valor e em Base64. 


Configuracao de nginx.conf
++++++++++++++++++++++++++

events { } # configuraçao de eventos

http { # configuraçao do protocolo HTTP, que e o protocolo que o Nginx ira utilizar
  server { # configuraçao do servidor
    listen 80; # porta que o Nginx vai escutar
    listen 443 ssl; # porta que o Nginx vai escutar para HTTPS e passando o parametro ssl para habilitar o HTTPS
    
    ssl_certificate /etc/nginx/tls/xpto.crt; # caminho do certificado TLS
    ssl_certificate_key /etc/nginx/tls/xpto.key; # caminho da chave privada

    location / { # configuraçao da rota /
      return 200 'Bem-vindo ao Nginx!\n'; # retorna o codigo 200 e a mensagem Bem-vindo ao Nginx!
      add_header Content-Type text/plain; # adiciona o header Content-Type com o valor text/plain
    } 
  }
}

Manifesto Exemplo ConfigMap
+++++++++++++++++++++++++++

apiVersion: v1
data:
  nginx.conf: |
    events { }

    http {
      server {
        listen 80;
        listen 443 ssl;
    
        ssl_certificate /etc/nginx/tls/xpto.crt;
        ssl_certificate_key /etc/nginx/tls/xpto.key;

        location / { 
          return 200 'Bem-vindo ao Nginx!\n';
          add_header Content-Type text/plain;
        } 
      }
    }
kind: ConfigMap
metadata:
  name: nginx-config



Manifesto Exemplo POD usando Secret TLS e ConfigMap
+++++++++++++++++++++++++++++++++++++++++++++++++++

apiVersion: v1
kind: Pod
metadata:
  name: nginx-with-secret-tls
  labels:
    app: nginx-tls
spec:
  containers:
  - name: nginx-container
    image: nginx
    ports:
    - containerPort: 80
    - containerPort: 443
    volumeMounts:
    - name: nginx-config-volume  # Nome do volume que sera utilizado para montar o arquivo de configuraçao do Nginx
      mountPath: /etc/nginx/nginx.conf # Local onde o arquivo de configuraçao do Nginx sera ser montado no POD
      subPath: nginx.conf # Nome do arquivo de configuraçao do Nginx
    - name: nginx-tls # Nome do volume que sera utilizado para os arquivos dos certificados (crt e key)
      mountPath: /etc/nginx/tls # Local onde o certificado TLS e a chave privada serao montados no POD
  volumes: # Lista de volumes que serao utilizados pelo POD
  - name: nginx-config-volume # Nome do volume que sera utilizado para montar o arquivo de configuraçao do Nginx
    configMap: # Tipo do volume a ser utilizado
      name: nginx-config # Nome do ConfigMap que sera utilizado pelo POD
  - name: nginx-tls # Nome do volume que sera utilizado para os arquivos dos certificados (crt e key)
    secret: # Tipo do volume a ser utilizado
      secretName: xpto-tls-secret # Nome do Secret que sera utilizado pelo POD
      items: # Lista de arquivos serao montados, pois dentro da secret temos dois arquivos, o certificado TLS e a chave privada
        - key: tls.crt # Nome do arquivo referente ao certificado. Este nome que esta no campo "data" do Secret
          path: xpto.crt # Local e nome do arquivo criado via openssl. Seu conteudo sera usado no campo "ssl_certificate" do arquivo nginx.conf
        - key: tls.key # Nome do arquivo referente a chave privada. Este nome que esta no campo "data" do Secret
          path: xpto.key # Local e nome do arquivo criado via openssl. Seu conteudo sera usado no campo "ssl_certificate_key" do arquivo nginx.conf